name: Phase B Runtime Verification

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  phase-b-runtime:
    name: Phase B Runtime Verification
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Start Docker
        run: |
          sudo systemctl start docker || true
          docker info

      - name: Generate certificates
        run: |
          if [ ! -f "certs/ca.crt" ]; then
            bash scripts/generate_certs.sh
          fi

      - name: Create secrets directory
        run: |
          mkdir -p secrets
          if [ ! -f "secrets/fernet_key.txt" ]; then
            python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())" > secrets/fernet_key.txt
          fi

      - name: Run Phase B Runtime Verification
        run: |
          make verify-phase-b-runtime
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1

      - name: Upload Evidence Pack
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase-b-runtime-evidence
          path: |
            docs/PHASE_B_RUNTIME_EVIDENCE.md
            phase_b_verification.log
          retention-days: 90

      - name: Check Verification Status
        if: always()
        run: |
          if grep -q "PHASE B RUNTIME: PASS" phase_b_verification.log && grep -q "EXIT_CODE=0" phase_b_verification.log; then
            echo "✅ Phase B Runtime Verification: PASS"
            exit 0
          else
            echo "❌ Phase B Runtime Verification: FAIL"
            echo "Last 50 lines of log:"
            tail -50 phase_b_verification.log
            exit 1
          fi


