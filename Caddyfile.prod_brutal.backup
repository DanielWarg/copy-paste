# Caddyfile for Brutal Security Profile - mTLS required for all paths except /health
# Client certificates are validated against CA certificate

{
    # Log level
    log {
        output stdout
        format json
        level INFO
    }
    
    # Auto HTTPS disabled (we handle TLS manually with mTLS)
    auto_https off
}

# Health check endpoint - NO mTLS required (for load balancer health checks)
# HTTP port 80 for health checks only
:80 {
    @health path /health
    reverse_proxy @health http://backend:8000
    
    # All other HTTP requests redirect to HTTPS (which requires mTLS)
    redir https://{host}{uri} permanent
}

# Main HTTPS endpoint with mTLS
# ALL paths on :443 require valid client certificate
:443 {
    # TLS configuration with client certificate authentication
    tls /etc/caddy/certs/server.crt /etc/caddy/certs/server.key {
        # Require and verify client certificates for ALL requests
        client_auth {
            mode require_and_verify
            trusted_ca_cert_file /etc/caddy/certs/ca.crt
        }
    }
    
    # All paths require valid client certificate (enforced by tls client_auth above)
    reverse_proxy http://backend:8000 {
        # Headers for backend
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For {remote_host}
        header_up X-Real-IP {remote}
        
        # Pass client certificate info to backend (for audit/logging)
        header_up X-Client-Cert {tls_client_cert_base64}
        header_up X-Client-Cert-Subject {tls_client_subject}
    }
    
    # Handle mTLS failures (Caddy returns 400 by default, we customize to 403)
    handle_errors {
        @mtls_error {
            status 400
        }
        respond @mtls_error "403 Forbidden - Valid client certificate required" 403 {
            close
        }
    }
}
